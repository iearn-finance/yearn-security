# Incident disclosure 2021-05-14

## Summary
- An conservative setting on `SingleSidedCrvDAI` strategy led to the strategy recording a large on paper loss when it was harvested out of turn.
- This led to a drop in share price on the yvDAI v2 vault.
- No funds were lost and the share price was fixed after the strategy was migrated to one without the conservative setting.

## Details of Incident

The`SingleSidedCrvDAI` strategy deposits DAI into the `ib3CRV` curve pool and then deposits that into another Yearn vault. The curve pool contains cyDAI, cyUSDT and cyUSDC. 

The value of the position the strategy is calculated in the `estimatedTotalAssets` function. It aims to: 
> return the total value that could *actually* be obtained from this Strategy if it were to divest its  entire position based on current on-chain conditions.

It simulates withdrawing all assets from the Curve pool back to DAI. In normal conditions this causes the strategy to conservatively report profit. But in times when the curve pool is unbalanced it can mean it reports a loss. That loss increases exponentially the further from balance the pool gets.

As the pool was heavilly unbalanced at the time of the incident a large loss was reported. Note that this loss was just on paper as no withdrawal from Curve pool took place. And no withdrawal causing this amount of loss would be possible due to slippage protection in the strategy.

The loss is reported during the `harvest` function call that updates vault profit and loss figures. Correct practice was to wait for the pool to rebalance before calling harvest. But the incident was set off by `yearn: Deployer 3` mistakenly calling harvest on `SingleSidedCrvDAI` rather than the sister strategy of `SingleSidedCrvUSDC`.

## Details of Fix

`estimatedTotalAssets` function was changed to report assets based on virtual price of the Curve pool rather than the realisable value. When harvested this reported a profit that was in excess of the loss reported in the incident harvest.

## Timeline of events
1. **May 14, 2021 08:32 (UTC)** `yearn: Deployer 3` calls harvest [[1]](#References) on SingleSidedCrvDAI by mistake. Meaning to harvest SingleSidedCrvUSDC. Causing a loss to be reported and share price of yvDAI to decrease. This mistake is unnoticed. 
3. **09:42** User `scoopytrooples` reports unusual drop in yvDAI vault share price from 1.043 to 1.035.
4. **09:47** War room is created and 12 Yearn team members start work on identifying the problem and creating a fix.
5. **10:13** Code changes for fix is finished and pushed [[2]](#References) for peer review. 
6. **10:49** New `SingleSidedCrvDAI` is deployed[[3]](#References) and migrate is queued in Yearn multisig.
7. **11:39** Migrate tx is executed[[4]](#References) and share price returns to normal.

## Third Party Disclosure

As per Yearn's security process document[[99]](#References), the project does not currently have any established bilateral disclosure agreements. In line with our security policy, no disclosure has therefore been made to third parties prior to to this publication.

## References

1. https://etherscan.io/tx/0x5558d40c511524b015cd307a134b3358f52326cf39c2c6e61604d5726c64dfdd
2. https://github.com/Grandthrax/SingleSidedCurve/commit/f12140f53a92e886bf3246c38cb9e97d2b2550dc
3. https://etherscan.io/tx/0xc8cf642eaf73e0adadcd629d534ebd4fee795196745e6f217f06f5ea5a1b34fc
4. https://etherscan.io/tx/0x66847f4dc80a6b4c32666972a9a68416d802d78b54619503fd0aec358fedb185

99. https://github.com/yearn/yearn-security/blob/master/SECURITY.md#yearns-security-process


